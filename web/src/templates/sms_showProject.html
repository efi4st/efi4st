{% extends "layout.html" %}
<style>
  /* Nur für das ProjectBOM-Widget */
  .project-bom-compact.small { font-size: .875rem; } /* Bootstrap "small" */
  .project-bom-compact .card-header { padding: .35rem .75rem; }
  .project-bom-compact .table td,
  .project-bom-compact .table th { padding: .3rem .5rem; }
  .project-bom-compact .btn-sm { padding: .125rem .4rem; font-size: .75rem; }
  .project-bom-compact .badge { font-size: .65rem; }
  .project-bom-compact .muted-code { opacity: .8; }
  .project-bom-compact .truncate-200 {
    max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
</style>
{% block content %}
<!-- Main jumbotron for a primary marketing message or call to action -->
<div class="jumbotron banner">
  <div class="container">
    <div class="row">
      <div class="col-md-3"></div>
      <div class="col-md-8">
        <h1 class="display-3" ></h1>
      </div>
      <div class="col-md-1"></div>
    </div>
  </div>
</div>

      <div class="container">
        {% if error|length > 1 %}
        <div class="alert alert-warning" role="alert">
          {{error}}
        </div>
        {% endif %}
      </div>

<div class="container">
  <div class="row">
    <h1>{{ project.Name }}&nbsp;&nbsp;&nbsp;&nbsp;</h1>
    <h3>Customer: &nbsp;{{ project.Customer }}</h3>
  </div>

  <div class="row">
    <div class="col-md-4">
      <ul class="list-group">
        <li class="list-group-item"><strong>Name:</strong> {{ project.Name }}</li>
        <li class="list-group-item"><strong>Customer:</strong> {{ project.Customer }}</li>
        <li class="list-group-item"><strong>Date:</strong> {{ project.Date|truncatechars:13 }}</li>
        <li class="list-group-item"><strong>Type:</strong> {{ project.Projecttype }}</li>
        <li class="list-group-item"><strong>Reference:</strong> {{ project.Reference }}</li>
        <li class="list-group-item"><strong>Project Reference:</strong> {{ project.Project_reference }}</li> <!-- NEU -->
        <li class="list-group-item"><strong>Plant Number:</strong> {{ project.Plant_number }}</li> <!-- NEU -->
        <li class="list-group-item"><strong>IMO/Plant/Factory:</strong> {{ project.Imo_plant_powerplant_factory }}</li> <!-- NEU -->
        <li class="list-group-item"><strong>Plant Type:</strong> {{ project.Plant_type }}</li> <!-- NEU -->
        <li class="list-group-item"><strong>Note:</strong> {{ project.Note }}</li> <!-- NEU -->
        <li class="list-group-item"><strong>Active:</strong> {{ project.Active }}</li>
      </ul>
    </div>

    <div class="col-md-8">
      <h3>Project Status History</h3>

      <table border="1" style="width:100%">
        <thead>
        <tr>
          <th>Status</th>
          <th>Note</th>
          <th>Date</th>
          <th>Access Group</th>
        </tr>
        </thead>
        <tbody>
        {% for log in statusLogs %}
        <tr {% if forloop.First %} style="background-color: #dff0d8;" {% endif %}>
          <td>{{log.Status}}</td>
          <td>{{log.Note}}</td>
          <td>{{log.CreatedAt}}</td>
          <td>{{log.AccessGroup}}</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      <a href="/sms_projectstatus/create/{{ project.Project_id }}">Update Status</a>
      <br />
      <br />
      <div class="card mt-3 shadow-sm project-bom-compact small">
        <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
          <strong class="fs-6">Linked Systems (Project BOM)</strong>
          <a class="btn btn-sm btn-outline-primary" href="/sms_projectBOM/createSMSProjectBOMForProject/{{ project.Project_id }}">Add</a>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0 align-middle">
              <thead class="table-light">
              <tr>
                <th>System</th>
                <th>Hardware Design</th>
                <th>Variant</th>
                <th>Order #</th>
                <th class="text-end">Actions</th>
              </tr>
              </thead>
              <tbody>
              {% for s in systemList %}
              <tr>
                <td>
                  {{ s.SystemType }}
                  <code class="muted-code">v{{ s.SystemVersion }}</code>
                </td>
                <td>
                  <a href="/sms_hardwaredesigns/show/{{ s.HardwareDesignID }}">{{ s.HardwareDesignName }}</a>
                  <small class="text-muted">v{{ s.HardwareDesignVersion }}</small>
                </td>
                <td>{{ s.VariantCode }} — {{ s.VariantName }}</td>
                <td class="truncate-200">{{ s.OrderNumber }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="/sms_projectBOM/{{ s.ProjectBOMID }}/edit">Edit</a>
                  <form action="/sms_projectBOM/{{ s.ProjectBOMID }}/delete" method="POST" style="display:inline-block" onsubmit="return confirm('Delete entry?');">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                  </form>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="7" class="text-center text-muted">No systems linked yet.</td></tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <hr>
  <hr>

  <div class="row">
    <div class="col-md-4">
      <h2>Functions:</h2>
      <div class="d-flex flex-column">
        <a class="btn btn-primary btn-lg mb-2" href="/sms_projects/getiplist/{{ project.Project_id }}" role="button">IP List</a>
        <a class="btn btn-primary btn-lg mb-2" href="/sms_project/{{ project.Project_id }}/export-structure" role="button">Component List (flat csv)</a>        <a class="btn btn-primary btn-lg mb-2" href="/sms_project/exportprojectstructureyaml/{{ project.Project_id }}" role="button">Component List (tree yaml txt)</a>
        <form action="" method="GET" class="mb-3">
          <div class="input-group">
            <select class="form-select" id="checkTypeSelect">
              <option value="all">Choose Checklist</option>
              <option value="SL1 Abnahme">SL1 Abnahme</option>
              <option value="Basic IBN Check">Basic IBN Check</option>
              <option value="Production Check">Production Check</option>
              <option value="Regular Re-Check">Regular Re-Check</option>
            </select>
            <a id="checkListButton" class="btn btn-primary btn-lg mb-2" href="#" role="button">Check Lists</a>
          </div>
        </form>
        <a class="btn btn-primary btn-lg" href="/sms_projectUpdates/show/{{ project.Project_id }}" role="button">Update</a>
      </div>
    </div>

    <div class="col-md-4">
      <h3>Project Settings:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <a href="/sms_projectSettingsLink/createSMSProjectSettingsLink/{{ project.Project_id }}" class="btn btn-primary">Add</a>
      </h3>
      <table class="table">
        <thead>
        <tr>
          <th>Setting Name</th>
          <th>Value</th>
          <th>Value Type</th>
        </tr>
        </thead>
        <tbody>
        {% for setting in projectSettings %}
        <tr>
          <td>{{ setting.KeyName }}</td>
          <td>{{ setting.DefaultValue }}</td>
          <td>{{ setting.ValueType }}</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="col-md-4">
      <h2>Statistics:</h2>
    </div>
  </div>

  <hr>
  <hr>

  <div class="row">
    <div class="col-md-8">
      <h2>DeviceInstances:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <a class="btn btn-primary btn-lg" href="/sms_deviceInstances/createSMSDeviceInstanceForProject/{{ project.Project_id }}" role="button" align="right">Add</a>
      </h2>
      <table class="table">
        <thead>
        <tr>
          <th>Device</th>
          <th>Version</th>
          <th>Belongs To</th>
          <th>Serial</th>
          <th>Status</th>
        </tr>
        </thead>
        <tbody>
        {% for d in deviceInstanceList %}
        <tr class="
      {% if d.VersionStatus == 'equal' %}table-success
      {% elif d.VersionStatus == 'containsNewer' %}table-warning
      {% elif d.VersionStatus == 'older' %}table-danger
      {% elif d.VersionStatus == 'newer' %}table-primary
      {% endif %}
    ">
          <td><a href="/sms_deviceInstances/show/{{ d.deviceInstance_id }}">{{ d.deviceType }}</a></td>
          <td>{{ d.deviceVersion }}</td>
          <td>
            {{ d.MinVersion }} – {{ d.MaxVersion }}
            {% if d.ContainsCurrent %}<br><strong>(contains current)</strong>{% endif %}
          </td>
          <td>{{ d.serialnumber }}</td>
          <td>
            {% if d.VersionStatus == 'equal' %}✅ match
            {% elif d.VersionStatus == 'containsNewer' %}⚠️ newer sys ready
            {% elif d.VersionStatus == 'older' %}⬇️ outdated
            {% elif d.VersionStatus == 'newer' %}⬆️ too new
            {% else %}❓ unknown
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="col-md-4">
    </div>
  </div>

  <hr>
  <hr>

  <div class="row">
    <div class="col-md-12">
      <h2>Issues:</h2>
      <table class="table">
        <thead>
        <tr>
          <th>Name</th>
          <th>Crit.</th>
          <th>Affected Devices</th>
        </tr>
        </thead>
        <tbody>
        {% for issue in issuesForThisProject %}
        <tr>
          <td><a href="/sms_issues/show/{{ issue.IssueID }}">{{ issue.IssueName|truncatechars:20 }}</a></td>
          <td>
            {% if issue.Criticality > 2 %}
            <h3 style="color:red">HIGH</h3>
            {% elif issue.Criticality < 2 %}
            <h3 style="color:greenyellow">LOW</h3>
            {% else %}
            <h3 style="color:orange">MEDIUM</h3>
            {% endif %}
          </td>
          <td>
            <ul>
              {% for device in issue.AffectedDevices %}
              <li>
                <strong>{{ device.DeviceName }}</strong> (ID: {{ device.DeviceID }}, Version: {{ device.DeviceVersion }})
                {% if device.Inherit %}
                <span class="text-muted">(Inherited)</span>
                {% endif %}
              </li>
              {% endfor %}
            </ul>
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <hr>
  <hr>
  <div class="row">
    <div class="col-md-6">
      <h3>
        Projekt-Checklisten&nbsp;&nbsp;
        <form action="/sms_checklistInstance/generateForProject/{{ project.Project_id }}" method="POST" class="d-inline">
          <div class="input-group">
            <select name="ChecklistTemplateID" class="form-select" required>
              <option value="">Neue Checkliste instanziieren...</option>
              {% for tmpl in checklistTemplates %}
              <option value="{{ tmpl.ChecklistTemplateID }}">{{ tmpl.Name }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-success" type="submit">
              <i class="fa fa-plus-circle"></i>
            </button>
          </div>
        </form>
      </h3>

      {% if checklistInstances %}
      <table class="table table-hover table-bordered table-sm mt-3">
        <thead class="table-dark">
        <tr>
          <th>Vorlage</th>
          <th>Status</th>
          <th>Erstellt am</th>
          <th>Details</th>
          <th><i class="fa fa-trash-o"></i></th>
        </tr>
        </thead>
        <tbody>
        {% for inst in checklistInstances %}
        <tr>
          <td>{{ inst.TemplateName }}</td>
          <td>
            {% if inst.Status == 'done' %}
            ✅ Abgeschlossen
            {% elif inst.Status == 'in_progress' %}
            🕒 In Bearbeitung
            {% else %}
            🟡 Offen
            {% endif %}
          </td>
          <td>{{ inst.GeneratedAt|truncatechars:19 }}</td>
          <td>
            <a class="btn btn-sm btn-outline-info" href="/sms_checklistInstance/show/{{ inst.ChecklistInstanceID }}">
              Anzeigen
            </a>
          </td>
          <td>
            <a class="btn btn-sm btn-outline-danger" href="/sms_checklistInstance/delete/{{ inst.ChecklistInstanceID }}">
              <i class="fa fa-trash"></i>
            </a>
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-muted">Keine Checklisten für dieses Projekt vorhanden.</p>
      {% endif %}
    </div>
  </div>
</div> <!-- /container -->

<script>
  document.getElementById("checkListButton").addEventListener("click", function(event) {
    event.preventDefault();
    let projectID = "{{ project.Project_id }}";
    let checkType = document.getElementById("checkTypeSelect").value;
    let url = "/sms_projects/checklist/" + projectID + "/" + encodeURIComponent(checkType);
    window.location.href = url;
  });
</script>
{% endblock %}