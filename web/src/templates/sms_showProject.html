{% extends "layout.html" %}
<style>
  /* Harmonisierte BOM-Optik – auf ListGroup-Niveau */
  .project-bom { font-size: 1rem; }
  .project-bom .card-header { padding: .5rem .75rem; }
  .project-bom .table td, .project-bom .table th { padding: .45rem .6rem; }
  .project-bom .btn-sm { padding: .2rem .5rem; font-size: .8rem; }
  .project-bom .muted-code { opacity: .8; }
  .project-bom .truncate-200 { max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Neue, kompakte Card-Optik */
  .card-tight .card-header { padding: .5rem .75rem; }
  .card-tight .card-body  { padding: .75rem; }
  .card-tight .table      { margin-bottom: 0; }

  /* Button-Grid für Actions */
  .btn-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
    gap: .5rem;
  }
  .btn-grid .btn { width: 100%; }

  /* Chips für betroffene Devices */
  .device-chip{
    display:inline-block; padding:.15rem .5rem; border-radius:999px;
    background:#f1f3f5; margin:.1rem .15rem; font-size:.8rem;
    border:1px solid rgba(0,0,0,.05);
  }
  .device-chip .muted{ opacity:.8; }
  /* kompakte Card */
  .card-tight .card-header{ padding:.5rem .75rem; }
  .card-tight .card-body{ padding:.75rem; }
  .card-tight .card-header{ padding:.5rem .75rem; }
  .card-tight .card-body{ padding:.75rem; }
  .project-meta .list-group-item{ padding:.6rem .75rem; }
  .project-meta .label{ font-size:.75rem; letter-spacing:.02em; text-transform:uppercase; color:#6c757d; }
  .project-meta .value{ font-weight:600; }
  .project-meta .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
  .project-meta .copy-btn{ border:none; background:transparent; color:#6c757d; padding:0 .25rem; }
  .project-meta .copy-btn:hover{ color:#0d6efd; }
  .clamp-3{
    display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical;
    overflow:hidden;
  }
  /* Titel der Kacheln deutlich hervorheben */
  .tile-title{
    font-weight: 700;          /* fett */
    font-size: 1.05rem;        /* etwas größer als fs-6 */
    line-height: 1.2;
    letter-spacing: .02em;
  }

  /* (optional) minimal mehr Luft im Header, damit der Titel wirkt */
  .card-tight .card-header{ padding: .65rem .9rem; }

  /* Project Info – moderne Meta-Zeilen */
  .project-meta .meta-item { padding:.6rem .75rem; }
  .project-meta .meta-head {
    display:flex; align-items:center; justify-content:space-between; margin-bottom:.2rem;
  }
  .project-meta .meta-head-left {
    display:flex; align-items:center; gap:.5rem;
  }
  .project-meta .meta-icon {
    width:1.25rem; text-align:center; color:#6c757d;
  }
  .project-meta .meta-title {
    font-weight:700; font-size:.95rem; line-height:1.2;
  }
  .project-meta .meta-actions .copy-btn{
    border:none; background:transparent; color:#6c757d; padding:0 .25rem;
  }
  .project-meta .meta-actions .copy-btn:hover{ color:#0d6efd; }
  .project-meta .meta-value {
    font-size:1.05rem; line-height:1.3;
  }
  .project-meta .mono{
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  }
  .clamp-3{
    display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
  }
  .sys-link{
    text-decoration: none;
    font-weight: 600; /* Name etwas betont */
  }
  .sys-link:hover{ text-decoration: underline; }

  .sys-version{
    color: #dc3545;          /* rot */
    font-weight: 700;        /* fett */
    font-size: 1rem;         /* einen Tick größer als HD-Version (<small>) */
    margin-left: .35rem;     /* Abstand zum Namen */
  }
  /* Dezente Einrückung der untergeordneten Device-Tabellen */
  .nested-devices {
    border-left: 3px solid #e9ecef;
    padding-left: 12px;
    background: #f8f9fa;
  }
</style>
{% block content %}
<!-- Main jumbotron for a primary marketing message or call to action -->
<div class="jumbotron banner">
  <div class="container">
    <div class="row">
      <div class="col-md-3"></div>
      <div class="col-md-8">
        <h1 class="display-3" ></h1>
      </div>
      <div class="col-md-1"></div>
    </div>
  </div>
</div>

      <div class="container">
        {% if error|length > 1 %}
        <div class="alert alert-warning" role="alert">
          {{error}}
        </div>
        {% endif %}
      </div>

<div class="container">
  <div class="row">
    <h1>{{ project.Name }}&nbsp;&nbsp;&nbsp;&nbsp;</h1>
    <h3>Customer: &nbsp;{{ project.Customer }}</h3>
  </div>
  <div class="row" style="margin-bottom:12px;">

    <!-- Type -->
    {% if project.Projecttype %}
    <div class="col-12 col-sm-6 col-md-3" style="margin-bottom:8px;">
      <div class="card" style="background:#f8f9fa;border:1px solid #e9ecef;border-radius:.25rem;">
        <div class="card-body" style="padding:.6rem .8rem;">
          <div style="display:flex;align-items:center;gap:.35rem;margin:0 0 .2rem 0;color:#6c757d;font-size:.75rem;text-transform:uppercase;letter-spacing:.04em;">
            <i class="fa fa-tag"></i><span>Type</span>
          </div>
          <p style="margin:0;font-size:1.1rem;font-weight:600;">{{ project.Projecttype }}</p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Date -->
    {% if project.Date %}
    <div class="col-12 col-sm-6 col-md-3" style="margin-bottom:8px;">
      <div class="card" style="background:#f8f9fa;border:1px solid #e9ecef;border-radius:.25rem;">
        <div class="card-body" style="padding:.6rem .8rem;">
          <div style="display:flex;align-items:center;gap:.35rem;margin:0 0 .2rem 0;color:#6c757d;font-size:.75rem;text-transform:uppercase;letter-spacing:.04em;">
            <i class="fa fa-calendar"></i><span>Date</span>
          </div>
          <p style="margin:0;font-size:1.1rem;font-weight:600;">{{ project.Date|truncatechars:13 }}</p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Plant Number -->
    {% if project.PlantNumber %}
    <div class="col-12 col-sm-6 col-md-3" style="margin-bottom:8px;">
      <div class="card" style="background:#f8f9fa;border:1px solid #e9ecef;border-radius:.25rem;">
        <div class="card-body" style="padding:.6rem .8rem;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin:0 0 .2rem 0;color:#6c757d;font-size:.75rem;text-transform:uppercase;letter-spacing:.04em;">
          <span style="display:flex;align-items:center;gap:.35rem;">
            <i class="fa fa-industry"></i><span>Plant Number</span>
          </span>
            <button class="copy-btn"
                    title="Copy"
                    data-copy="{{ project.PlantNumber }}"
                    style="border:none;background:transparent;color:#6c757d;padding:0 .25rem;cursor:pointer;">
              <i class="fa fa-copy"></i>
            </button>
          </div>
          <p style="margin:0;font-size:1.1rem;font-weight:600;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;">
            {{ project.PlantNumber }}
          </p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Reference -->
    {% if project.Reference %}
    <div class="col-12 col-sm-6 col-md-3" style="margin-bottom:8px;">
      <div class="card" style="background:#f8f9fa;border:1px solid #e9ecef;border-radius:.25rem;">
        <div class="card-body" style="padding:.6rem .8rem;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin:0 0 .2rem 0;color:#6c757d;font-size:.75rem;text-transform:uppercase;letter-spacing:.04em;">
          <span style="display:flex;align-items:center;gap:.35rem;">
            <i class="fa fa-bookmark"></i><span>Reference</span>
          </span>
            <button class="copy-btn"
                    title="Copy"
                    data-copy="{{ project.Reference }}"
                    style="border:none;background:transparent;color:#6c757d;padding:0 .25rem;cursor:pointer;">
              <i class="fa fa-copy"></i>
            </button>
          </div>
          <p style="margin:0;font-size:1.1rem;font-weight:600;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;">
            {{ project.Reference }}
          </p>
        </div>
      </div>
    </div>
    {% endif %}

  </div>
  <div class="row">

    <div class="col-md-4">
      <div class="card shadow-sm card-tight">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <strong class="fs-6">Project Info</strong>
          {% if project.PlantType %}
          {% set badgeClass = "bg-secondary" %}
          {% if project.PlantType == "IMO" %}{% set badgeClass = "bg-primary" %}{% endif %}
          {% if project.PlantType == "Plant" %}{% set badgeClass = "bg-success" %}{% endif %}
          {% if project.PlantType == "PowerPlant" %}{% set badgeClass = "bg-warning text-dark" %}{% endif %}
          {% if project.PlantType == "Factory" %}{% set badgeClass = "bg-info text-dark" %}{% endif %}
          <span class="badge {{ badgeClass }}">{{ project.PlantType }}</span>
          {% endif %}
        </div>

        <div class="list-group list-group-flush project-meta">

          {% if project.ProjectReference %}
          <div class="list-group-item meta-item">
            <div class="meta-head">
              <div class="meta-head-left">
                <span class="meta-icon"><i class="fa fa-hashtag"></i></span>
                <span class="meta-title"><b>Project Reference</b></span>
              </div>
            </div>
            <div class="meta-value mono">{{ project.ProjectReference }}</div>
          </div>
          {% endif %}

          {% if project.IMOPlantPowerPlantFactory %}
          <div class="list-group-item meta-item">
            <div class="meta-head">
              <div class="meta-head-left">
                <span class="meta-icon"><i class="fa fa-building"></i></span>
                <span class="meta-title"><b>IMO/Plant/Factory</b></span>
              </div>
            </div>
            <div class="meta-value">{{ project.IMOPlantPowerPlantFactory }}</div>
          </div>
          {% endif %}

          {% if project.Note %}
          <div class="list-group-item meta-item">
            <div class="meta-head">
              <div class="meta-head-left">
                <span class="meta-icon"><i class="fa fa-sticky-note-o"></i></span>
                <span class="meta-title"><b>Note</b></span>
              </div>
            </div>
            <div class="meta-value clamp-3" id="proj-note">{{ project.Note }}</div>
          </div>
          {% endif %}

        </div>
      </div>
    </div>

    <!-- RECHTS: Status-Historie + Unassigned Devices -->
    <div class="col-md-8">
      <h3>Project Status History</h3>
      <table border="1" style="width:100%">
        <thead>
        <tr>
          <th>Status</th>
          <th>Note</th>
          <th>Date</th>
          <th>Access Group</th>
        </tr>
        </thead>
        <tbody>
        {% for log in statusLogs %}
        <tr {% if forloop.First %} style="background-color: #dff0d8;" {% endif %}>
          <td>{{log.Status}}</td>
          <td>{{log.Note}}</td>
          <td>{{log.CreatedAt}}</td>
          <td>{{log.AccessGroup}}</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      <a href="/sms_projectstatus/create/{{ project.Project_id }}">Update Status</a>

      <!-- UNASSIGNED DEVICES rutschen hierher -->
      <div class="card mt-3 shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <span class="tile-title">Unassigned Devices (Spares)</span>
          <div style="margin-top:.15rem;">
    <span class="badge"
          style="background:#f8f9fa;border:1px solid #dee2e6;color:#6c757d;
                 font-size:.75rem;font-weight:600;padding:.2rem .45rem;">
      Assign to a system to evaluate compatibility
    </span>
          </div>
          <a class="btn btn-sm btn-primary" href="/sms_deviceInstances/createSMSDeviceInstanceForProject/{{ project.Project_id }}">Add</a>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0 align-middle">
              <thead class="table-light">
              <tr>
                <th>Device</th>
                <th>Version</th>
                <th>Serial</th>
                <th>Config</th>
                <th>Provisioner</th>
                <th>Status</th>
                <th class="text-end">Assign</th>
              </tr>
              </thead>
              <tbody>
              {% for d in unassignedDeviceList %}
              <tr>
                <td><a href="/sms_deviceInstances/show/{{ d.deviceInstance_id }}">{{ d.deviceType }}</a></td>
                <td>{{ d.deviceVersion }}</td>
                <td><code>{{ d.serialnumber }}</code></td>
                <td class="text-truncate" style="max-width:220px;">{{ d.configuration }}</td>
                <td>{{ d.provisioner }}</td>
                <td><span class="text-muted">—</span></td> <!-- kein Status -->
                <td class="text-end">
                  {% if systemList and systemList|length > 0 %}
                  <form action="/sms_deviceInstances/linkToPBOM" method="POST" class="d-inline">
                    <input type="hidden" name="DeviceInstanceID" value="{{ d.deviceInstance_id }}">
                    <div class="input-group input-group-sm" style="max-width:360px; float:right;">
                      <select class="form-select form-select-sm" name="ProjectBOMID" required>
                        {% for s in systemList %}
                        <option value="{{ s.ProjectBOMID }}">{{ s.SystemType }} v{{ s.SystemVersion }}</option>
                        {% endfor %}
                      </select>
                      <button class="btn btn-sm btn-outline-primary" type="submit">Assign</button>
                    </div>
                  </form>
                  {% else %}
                  <span class="text-muted">No systems in project yet.</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="7" class="text-center text-muted">No unassigned devices.</td></tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <hr>
  <hr>
  <!-- VOLLBREITE: Systems + Devices -->
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card mt-3 shadow-sm project-bom">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <strong class="fs-6">Linked Systems (Project BOM)</strong>
          <a class="btn btn-sm btn-outline-primary" href="/sms_projectBOM/createSMSProjectBOMForProject/{{ project.Project_id }}">Add</a>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0 align-middle">
              <thead class="table-light">
              <tr>
                <th>System</th>
                <th>Hardware Design</th>
                <th>Variant</th>
                <th>Order #</th>
                <th class="text-end">Actions</th>
              </tr>
              </thead>
              <tbody>
              {% for s in systemList %}
              <!-- Hauptzeile -->
              <tr>
                <td>
                  <a class="sys-link" href="/sms_systems/show/{{ s.SystemID }}">{{ s.SystemType }}</a>
                  <span class="sys-version">v{{ s.SystemVersion }}</span>
                </td>
                <td>
                  <a href="/sms_hardwaredesigns/show/{{ s.HardwareDesignID }}">{{ s.HardwareDesignName }}</a>
                  <small class="text-muted">v{{ s.HardwareDesignVersion }}</small>
                </td>
                <td>{{ s.VariantCode }} — {{ s.VariantName }}</td>
                <td class="truncate-200">{{ s.OrderNumber }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary"
                     href="/sms_deviceInstances/createForProjectBOM/{{ s.ProjectBOMID }}">
                    Add Device
                  </a>
                  <button class="btn btn-sm btn-outline-secondary"
                          type="button"
                          data-toggle="collapse"
                          data-target="#pbom-{{ s.ProjectBOMID }}-devices"
                          aria-expanded="true"
                          aria-controls="pbom-{{ s.ProjectBOMID }}-devices">
                    Devices ({{ s.DeviceCount }})
                  </button>
                  <form action="/sms_projectBOM/{{ s.ProjectBOMID }}/delete" method="POST" style="display:inline-block"
                        onsubmit="return confirm('Delete entry?');">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                  </form>
                </td>
              </tr>

              <!-- Collapse-Zeile (standardmäßig offen + eingerückt) -->
              <tr>
                <td colspan="5" class="p-0">
                  <div id="pbom-{{ s.ProjectBOMID }}-devices" class="collapse show">
                    <div class="nested-devices p-2" style="border-left:30px solid #e9ecef; padding-left:12px; background:#f8f9fa;">
                      {% if s.DeviceCount > 0 %}
                      <div class="table-responsive">
                        <table class="table table-sm mb-0 align-middle">
                          <thead>
                          <tr>
                            <th>Device</th>
                            <th>Version</th>
                            <th>Belongs To</th>
                            <th>Serial</th>
                            <th>Config</th>
                            <th>Provisioner</th>
                            <th>Status</th>
                            <th class="text-end">Actions</th>
                          </tr>
                          </thead>
                          <tbody>
                          {% for d in s.DeviceList %}
                          <tr class="
                          {% if d.VersionStatus == 'equal' %}table-success
                          {% elif d.VersionStatus == 'containsNewer' %}table-warning
                          {% elif d.VersionStatus == 'older' %}table-danger
                          {% elif d.VersionStatus == 'newer' %}table-primary
                          {% endif %}
                        ">
                            <td><a href="/sms_deviceInstances/show/{{ d.DeviceInstanceID }}">{{ d.DeviceName }}</a></td>
                            <td>{{ d.DeviceVersion }}</td>
                            <td>
                              {{ d.MinVersion }} – {{ d.MaxVersion }}
                              {% if d.ContainsCurrent %}
                              <br><small class="text-muted">(contains current)</small>
                              {% endif %}
                            </td>
                            <td><code>{{ d.Serialnumber }}</code></td>
                            <td class="text-truncate" style="max-width:220px;">{{ d.Configuration }}</td>
                            <td>{{ d.Provisioner }}</td>
                            <td>
                              {% if d.VersionStatus == 'equal' %}✅ match
                              {% elif d.VersionStatus == 'containsNewer' %}⚠️ newer sys ready
                              {% elif d.VersionStatus == 'older' %}⬇️ outdated
                              {% elif d.VersionStatus == 'newer' %}⬆️ too new
                              {% else %}❓ unknown
                              {% endif %}
                            </td>
                            <td class="text-end">
                              <form action="/sms_deviceInstances/unlinkFromPBOM" method="POST" class="d-inline">
                                <input type="hidden" name="ProjectBOMID" value="{{ s.ProjectBOMID }}">
                                <input type="hidden" name="DeviceInstanceID" value="{{ d.DeviceInstanceID }}">
                                <button class="btn btn-sm btn-outline-danger" type="submit">Unlink</button>
                              </form>
                            </td>
                          </tr>
                          {% endfor %}
                          </tbody>
                        </table>
                      </div>
                      {% else %}
                      <div class="text-muted">No devices linked to this system yet.</div>
                      {% endif %}
                    </div>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted">No systems linked yet.</td></tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <hr>
  <hr>

  <div class="row">
    <div class="col-md-4">
      <div class="card shadow-sm card-tight">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <strong class="fs-6">Quick Actions</strong>
        </div>
        <div class="card-body">
          <div class="btn-grid mb-2">
            <a class="btn btn-outline-primary" href="/sms_projects/getiplist/{{ project.Project_id }}">
              <i class="fa fa-sitemap me-1"></i> IP&nbsp;List
            </a>
            <a class="btn btn-outline-primary" href="/sms_project/{{ project.Project_id }}/export-structure">
              <i class="fa fa-table me-1"></i> Component List (CSV)
            </a>
            <a class="btn btn-outline-primary" href="/sms_project/exportprojectstructureyaml/{{ project.Project_id }}">
              <i class="fa fa-code me-1"></i> Component List (YAML)
            </a>
            <a class="btn btn-outline-secondary" href="/sms_projectUpdates/show/{{ project.Project_id }}">
              <i class="fa fa-refresh me-1"></i> Updates
            </a>
          </div>

          <hr class="my-3">

          <!-- Checklists: kompakte Input-Group, Buttons rechts ausgerichtet -->
          <form action="" method="GET">
            <div class="row g-2 align-items-center">
              <div class="col-8">
                <select class="form-select form-select-sm" id="checkTypeSelect">
                  <option value="all">Choose Checklist</option>
                  <option value="SL1 Abnahme">SL1 Abnahme</option>
                  <option value="Basic IBN Check">Basic IBN Check</option>
                  <option value="Production Check">Production Check</option>
                  <option value="Regular Re-Check">Regular Re-Check</option>
                </select>
              </div>
              <div class="col-4">
                <a id="checkListButton" class="btn btn-sm btn-primary w-100" href="#" role="button">
                  <i class="fa fa-list-ul me-1"></i> Open
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm card-tight">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <strong class="fs-6">Project Settings</strong>
          <a href="/sms_projectSettingsLink/createSMSProjectSettingsLink/{{ project.Project_id }}" class="btn btn-sm btn-primary">
            <i class="fa fa-plus"></i> Add
          </a>
        </div>
        <div class="card-body">
          {% if projectSettings %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Value</th>
                <th>Type</th>
              </tr>
              </thead>
              <tbody>
              {% for setting in projectSettings %}
              <tr>
                <td class="text-nowrap">{{ setting.KeyName }}</td>
                <td class="text-truncate" style="max-width: 260px;">{{ setting.DefaultValue }}</td>
                <td class="text-muted">{{ setting.ValueType }}</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted mb-0">No settings linked yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm card-tight">
        <div class="card-header bg-light">
          <strong class="fs-6">Statistics</strong>
        </div>
        <div class="card-body">
          <p class="text-muted mb-0">Coming soon…</p>
        </div>
      </div>
    </div>
  </div>

  <hr>
  <hr>

  <div class="row">
    <div class="col-md-4">
    </div>
  </div>

  <hr>
  <hr>

  <div class="row">
    <div class="col-md-12">
      <h2>Issues:</h2>
      <div class="card mt-3 shadow-sm card-tight">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <strong class="fs-6">Issues</strong>
          <!-- optional: <a class="btn btn-sm btn-outline-primary" href="/sms_issues">Manage</a> -->
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0 align-middle">
              <thead class="table-light">
              <tr>
                <th>Issue</th>
                <th>Severity</th>
                <th>Affected Devices</th>
                <th class="text-end">Actions</th>
              </tr>
              </thead>
              <tbody>
              {% for issue in issuesForThisProject %}
              <tr>
                <td>
                  <a href="/sms_issues/show/{{ issue.IssueID }}">{{ issue.IssueName|truncatechars:40 }}</a>
                </td>
                <td>
                  {% if issue.Criticality > 2 %}
                  <span class="badge bg-danger">High</span>
                  {% elif issue.Criticality < 2 %}
                  <span class="badge bg-success">Low</span>
                  {% else %}
                  <span class="badge bg-warning text-dark">Medium</span>
                  {% endif %}
                </td>
                <td>
                  <div>
                    {% for device in issue.AffectedDevices %}
                    {% if forloop.counter <= 3 %}
                    <span class="device-chip">
                      <strong>{{ device.DeviceName }}</strong>
                      <span class="muted">v{{ device.DeviceVersion }}</span>
                      {% if device.Inherit %}<span class="muted"> · inherited</span>{% endif %}
                    </span>
                    {% endif %}
                    {% endfor %}

                    {% if issue.AffectedDevices|length > 3 %}
                    <a class="btn btn-link btn-sm p-0 ms-1"
                       data-bs-toggle="collapse"
                       href="#aff-{{ issue.IssueID }}"
                       role="button"
                       aria-expanded="false"
                       aria-controls="aff-{{ issue.IssueID }}">
                      +{{ issue.AffectedDevices|length|add:"-3" }} more
                    </a>
                    <div class="collapse mt-2" id="aff-{{ issue.IssueID }}">
                      {% for device in issue.AffectedDevices %}
                      {% if forloop.counter > 3 %}
                      <span class="device-chip">
                          <strong>{{ device.DeviceName }}</strong>
                          <span class="muted">v{{ device.DeviceVersion }}</span>
                          {% if device.Inherit %}<span class="muted"> · inherited</span>{% endif %}
                        </span>
                      {% endif %}
                      {% endfor %}
                    </div>
                    {% endif %}
                  </div>
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-info" href="/sms_issues/show/{{ issue.IssueID }}">Details</a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted">No issues for this project.</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <hr>
  <hr>
  <div class="row">
    <div class="col-md-6">
      <h3>
        Projekt-Checklisten&nbsp;&nbsp;
        <form action="/sms_checklistInstance/generateForProject/{{ project.Project_id }}" method="POST" class="d-inline">
          <div class="input-group">
            <select name="ChecklistTemplateID" class="form-select" required>
              <option value="">Neue Checkliste instanziieren...</option>
              {% for tmpl in checklistTemplates %}
              <option value="{{ tmpl.ChecklistTemplateID }}">{{ tmpl.Name }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-success" type="submit">
              <i class="fa fa-plus-circle"></i>
            </button>
          </div>
        </form>
      </h3>

      {% if checklistInstances %}
      <table class="table table-hover table-bordered table-sm mt-3">
        <thead class="table-dark">
        <tr>
          <th>Vorlage</th>
          <th>Status</th>
          <th>Erstellt am</th>
          <th>Details</th>
          <th><i class="fa fa-trash-o"></i></th>
        </tr>
        </thead>
        <tbody>
        {% for inst in checklistInstances %}
        <tr>
          <td>{{ inst.TemplateName }}</td>
          <td>
            {% if inst.Status == 'done' %}
            ✅ Abgeschlossen
            {% elif inst.Status == 'in_progress' %}
            🕒 In Bearbeitung
            {% else %}
            🟡 Offen
            {% endif %}
          </td>
          <td>{{ inst.GeneratedAt|truncatechars:19 }}</td>
          <td>
            <a class="btn btn-sm btn-outline-info" href="/sms_checklistInstance/show/{{ inst.ChecklistInstanceID }}">
              Anzeigen
            </a>
          </td>
          <td>
            <a class="btn btn-sm btn-outline-danger" href="/sms_checklistInstance/delete/{{ inst.ChecklistInstanceID }}">
              <i class="fa fa-trash"></i>
            </a>
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-muted">Keine Checklisten für dieses Projekt vorhanden.</p>
      {% endif %}
    </div>
  </div>
</div> <!-- /container -->

<script>
  document.getElementById("checkListButton").addEventListener("click", function(event) {
    event.preventDefault();
    let projectID = "{{ project.Project_id }}";
    let checkType = document.getElementById("checkTypeSelect").value;
    let url = "/sms_projects/checklist/" + projectID + "/" + encodeURIComponent(checkType);
    window.location.href = url;
  });
</script>
<script>
  document.querySelectorAll('.project-meta .copy-btn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const val = btn.getAttribute('data-copy') || '';
      navigator.clipboard?.writeText(val).then(()=>{
        btn.innerHTML = '<i class="fa fa-check text-success"></i>';
        setTimeout(()=>btn.innerHTML='<i class="fa fa-copy"></i>', 1200);
      });
    });
  });
</script>
<script>
  document.querySelectorAll('.project-meta .copy-btn, .stat-copy').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const val = btn.getAttribute('data-copy') || '';
      navigator.clipboard?.writeText(val).then(()=>{
        btn.innerHTML = '<i class="fa fa-check text-success"></i>';
        setTimeout(()=>btn.innerHTML='<i class="fa fa-copy"></i>', 1200);
      });
    });
  });
</script>
<script>
  document.querySelectorAll('.copy-btn').forEach(function(btn){
    btn.addEventListener('click', function(e){
      e.preventDefault();
      var val = btn.getAttribute('data-copy') || '';
      if (navigator.clipboard) {
        navigator.clipboard.writeText(val).then(function(){
          btn.innerHTML = '<i class="fa fa-check" style="color:#28a745;"></i>';
          setTimeout(function(){ btn.innerHTML = '<i class="fa fa-copy"></i>'; }, 1200);
        });
      }
    });
  });
</script>
{% endblock %}