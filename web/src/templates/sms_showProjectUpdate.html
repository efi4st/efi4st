{% extends "layout.html" %}

{% block content %}
<!-- Main jumbotron for a primary marketing message or call to action -->
<div class="jumbotron banner">
  <div class="container">
    <div class="row">
      <div class="col-md-3"></div>
      <div class="col-md-8">
        <h1 class="display-3" ></h1>
      </div>
      <div class="col-md-1"></div>
    </div>
  </div>
</div>

      <div class="container">
        {% if error|length > 1 %}
        <div class="alert alert-warning" role="alert">
          {{error}}
        </div>
        {% endif %}
      </div>

<div class="container">
  <h1>Project Update: {{ projectInfo.name }} - (ID: {{ projectInfo.project_id }})</h1>
  <div class="row">
    {% for systemType, deviceSoftwareList in systemTypeMap %}

    {# SystemType-Name bestimmen (ohne set oder namespace) #}
    {% for item in systemTypeNameList %}
    {% if item.Key == systemType %}
    {% with item.Value as systemTypeName %}

    <div class="d-flex justify-content-between align-items-start mt-4 mb-2">
      <h4 class="mb-0">System Type: {{ systemTypeName }}</h4>

      {# CLEAN STATUS — wird nun mittig eingebaut, falls nötig #}
      {% for item in systemTypeCleanList %}
      {% if item.Key == systemType and not item.Value %}
      <div class="alert alert-warning py-1 px-3 mb-0 mx-auto text-center">
        ⚠️ Misconfigured System?: Inaccurate device versions!
      </div>
      {% endif %}
      {% endfor %}

      {# DROPDOWN: Nur Updates für den aktuellen SystemType anzeigen #}
      {% for updateGroup in systemTypeUpdates %}
      {% if updateGroup.SystemTypeName == systemTypeName %}
      <form method="get" action="" class="ms-auto">
        <input type="hidden" name="system_type_id" value="{{ systemType }}" />
        <div class="mb-0">
          <label for="updateSelect{{ systemType }}" class="me-2">Update auswählen:</label>
          <select name="update_id" id="updateSelect{{ systemType }}" onchange="this.form.submit()" class="form-select d-inline-block w-auto">
            <option value="">-- Kein Update ausgewählt --</option>
            {% for update in updateGroup.Updates %}
            <option value="{{ update.ID }}">
              Nach {{ update.ToSystemVersion }} ({{ update.UpdateType }})
              {% if update.ProjectName %} [Projekt: {{ update.ProjectName }}] {% endif %}
            </option>
            {% endfor %}
          </select>
        </div>
      </form>
      {% endif %}
      {% endfor %}
    </div>

    {# TABELLE START #}
    <table class="table table-bordered">
      <thead class="table-dark">
      <tr>
        <th class="text-start">Device/Software</th>
        <th>Database</th>
        <th>Live-System</th>
        <th>Update-Package</th>
      </tr>
      </thead>
      <tbody>
      {% for entry in deviceSoftwareList %}
      <tr class="bg-lightgrey">
        <td class="text-start w-65">
          <strong>{{ entry.DeviceName }}</strong>
          {% if entry.DeviceCount > 1 %}
          <span class="small">({{ entry.DeviceCount }}x)</span>
          {% endif %}
          {% if entry.MostCommonSystemVersion %}
          {% if entry.IsInvalidSystemVersion %}
          <span class="text-danger small fst-italic">(belongs to System {{ entry.MostCommonSystemVersion }})</span>
          {% else %}
          <span class="text-muted small fst-italic">(belongs to System {{ entry.MostCommonSystemVersion }})</span>
          {% endif %}
          {% endif %}
        </td>
        <td>
          {{ entry.DeviceVersion }}
          {% if entry.ShortenedSystemVersions %}
          <div class="text-end small fst-italic text-muted">
            Systems: {{ entry.ShortenedSystemVersions }}
          </div>
          {% endif %}
        </td>
        <td class="bg-secondary text-white">-</td>
        <td class="bg-secondary text-white">
          {% set foundUpdate = false %}
          {% for deviceUpdate in devicesForUpdate %}
          {% if deviceUpdate.DeviceName == entry.DeviceName %}
          <span>{{ deviceUpdate.DeviceVersion }}</span>
          {% set foundUpdate = true %}
          {% endif %}
          {% endfor %}
          {% if not foundUpdate %}
          <span>No update found</span>
          {% endif %}
        </td>
      </tr>

      {% for software in entry.SoftwareList %}
      <tr class="bg-lightergrey">
        <td class="text-start w-65 ps-4">↳ {{ software.SoftwareName }}</td>
        <td>
          {{ software.SoftwareVersion }}
          {% if entry.MostCommonSystemVersion %}
          <div class="text-end small fst-italic">
            Systems: {{ entry.MostCommonSystemVersion }}
          </div>
          {% endif %}
        </td>
        <td class="bg-secondary text-white">-</td>
        <td class="bg-secondary text-white">
          {% set foundUpdate = false %}
          {% for softwareUpdate in softwareForUpdate %}
          {% if softwareUpdate.SoftwareName == software.SoftwareName %}
          <span>{{ softwareUpdate.SoftwareVersion }}</span>
          {% set foundUpdate = true %}
          {% endif %}
          {% endfor %}
          {% if not foundUpdate %}
          <span>No update found</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      {% endfor %}
      </tbody>
    </table>
    {% endwith %}
    {% endif %}
    {% endfor %}
    {% endfor %}
  </div>
  <div>
    <h4>Devices for Update:</h4>
    <ul>
      {% for device in devicesForUpdate %}
      <li>{{ device.DeviceName }} - {{ device.DeviceVersion }}</li>
      {% endfor %}
    </ul>
  </div>

  <div>
    <h4>Software for Update:</h4>
    <ul>
      {% for software in softwareForUpdate %}
      <li>{{ software.SoftwareName }} - {{ software.SoftwareVersion }}</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock %}